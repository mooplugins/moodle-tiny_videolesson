define("tiny_videoaws/ui",["exports","./common","./options","core/templates","tiny_videolesson/modal","core/modal_events","core/modal_factory","core/pending","core/ajax","mod_videolesson/table"],(function(_exports,_common,_options,_templates,_modal,_modal_events,_modal_factory,_pending,_ajax,_table){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny Video Lesson Content configuration.
   *
   * @module    tiny_videolesson/ui
   * @author     BitKea Technologies LLP
   * @copyright  2024 BitKea Technologies LLP (https://www.bitkea.com)
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory),_pending=_interopRequireDefault(_pending),_ajax=_interopRequireDefault(_ajax);let openingSelection=null;_exports.handleAction=editor=>{openingSelection=editor.selection.getBookmark(),displayDialogue(editor)};const getTemplateContext=async(editor,data)=>{var _permissions$embed;const canEmbed=null!==(_permissions$embed=(0,_options.getPermissions)(editor).embed)&&void 0!==_permissions$embed&&_permissions$embed,canUploadAndEmbed=canEmbed,videos=await fetchVideos();return Object.assign({},{elementid:editor.id,canUpload:true,canEmbed:canEmbed,canUploadAndEmbed:canUploadAndEmbed,showOptions:!1,videos:videos,uploadlink:!0,tableid:Date.now()},data)},fetchVideos=async()=>{try{const request={methodname:"tiny_videolesson_get_videos",args:{}},responses=await _ajax.default.call([request])[0];return responses.list||[]}catch(error){return console.error("Error fetching videos:",error),[]}},handleDialogueSubmission=async(editor,modal,data)=>{const pendingPromise=new _pending.default("tiny_videolesson:handleDialogueSubmission"),tbl=modal.getRoot().find("table").get(0);if(!tbl)return console.error("Table element not found."),void pendingPromise.reject();const submittedHash=tbl.dataset.selected,submittedTitle=tbl.dataset.title;if(!submittedHash)return console.error(" No hash selected, represent the dialogue with an error"),modal.destroy(),displayDialogue(editor,Object.assign({},data,{hash:submittedHash,invalidHash:!0})),void pendingPromise.resolve();try{const content=await(0,_templates.renderForPromise)("".concat(_common.component,"/content"),{hash:submittedHash.toString(),title:submittedTitle.toString()});editor.selection.moveToBookmark(openingSelection),editor.execCommand("mceInsertContent",!1,content.html),editor.selection.moveToBookmark(openingSelection),tbl.dataset.selected="",tbl.dataset.title="";tbl.querySelectorAll("tbody tr").forEach((row=>row.classList.remove("selected"))),console.log("Dialog submission handled and table cleared.")}catch(error){console.error("Error handling dialog submission:",error)}finally{pendingPromise.resolve()}modal.destroy()},displayDialogue=async function(editor){let data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const templatecontext=await getTemplateContext(editor,data),modal=await _modal_factory.default.create({type:_modal.default.TYPE,templateContext:templatecontext,large:!0});modal.show();const $root=modal.getRoot();(0,_table.initTable)("videolist"+templatecontext.tableid,"videolistsearchinput"+templatecontext.tableid),$root.on(_modal_events.default.save,((event,modal)=>{handleDialogueSubmission(editor,modal,data)})),$root.on(_modal_events.default.shown,(function(){const tbl=modal.getRoot().find("table").get(0);tbl?tbl.addEventListener("click",(event=>{const row=event.target.closest("tr");if(!row||!tbl.contains(row))return;const hash=row.dataset.contenthash,title=row.dataset.title;if(hash){tbl.querySelectorAll("tbody tr").forEach((r=>r.classList.remove("selected"))),row.classList.add("selected"),tbl.dataset.selected=hash,tbl.dataset.title=title}else console.warn("No content hash found for the selected row.")})):console.error("Table with id #videolist not found.")}))}}));

//# sourceMappingURL=ui.min.js.map