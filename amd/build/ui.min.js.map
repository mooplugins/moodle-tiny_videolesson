{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Video Lesson Content configuration.\n *\n * @module    tiny_videolesson/ui\n * @author     BitKea Technologies LLP\n * @copyright  2024 BitKea Technologies LLP (https://www.bitkea.com)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {component} from './common';\nimport {getPermissions} from './options';\nimport {renderForPromise} from 'core/templates';\nimport Modal from 'tiny_videolesson/modal';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Pending from 'core/pending';\nimport Ajax from 'core/ajax';\nimport {initTable} from 'mod_videolesson/table';\nlet openingSelection = null;\n\nexport const handleAction = (editor) => {\n    openingSelection = editor.selection.getBookmark();\n    displayDialogue(editor);\n};\n\n/**\n * Get the template context for the dialogue.\n *\n * @param {Editor} editor\n * @param {object} data\n * @returns {object} data\n */\n\nconst getTemplateContext = async (editor, data) => {\n    const permissions = getPermissions(editor);\n\n    const canUpload = true;\n    const canEmbed = permissions.embed ?? false;\n    const canUploadAndEmbed = canUpload && canEmbed;\n\n    // Fetch videos from the database\n    const videos = await fetchVideos();\n    return Object.assign({}, {\n        elementid: editor.id,\n        canUpload,\n        canEmbed,\n        canUploadAndEmbed,\n        showOptions: false,\n        videos,\n        uploadlink: true,\n        tableid: Date.now(),\n    }, data);\n};\n\n/**\n * Fetch videos from the database.\n *\n * @returns {Promise<Array>} A promise that resolves to an array of video objects.\n */\nconst fetchVideos = async () => {\n    try {\n        const request = {\n            methodname: 'tiny_videolesson_get_videos',\n            args: {}\n        };\n        const responses = await Ajax.call([request])[0];\n        const videos = responses.list;\n        return videos || [];\n    } catch (error) {\n        console.error('Error fetching videos:', error);\n        return [];\n    }\n};\n\nconst handleDialogueSubmission = async (editor, modal, data) => {\n    const pendingPromise = new Pending('tiny_videolesson:handleDialogueSubmission');\n\n    const tbl = modal.getRoot().find('table').get(0);\n    if (!tbl) {\n        console.error('Table element not found.');\n        pendingPromise.reject();\n        return;\n    }\n\n    const submittedHash = tbl.dataset.selected;\n    const submittedTitle = tbl.dataset.title;\n    if (!submittedHash) {\n        console.error(' No hash selected, represent the dialogue with an error');\n        modal.destroy();\n        displayDialogue(editor, Object.assign({}, data, {\n            hash: submittedHash,\n            invalidHash: true,\n        }));\n        pendingPromise.resolve();\n        return;\n    }\n\n    try {\n        const content = await renderForPromise(`${component}/content`, {\n            hash: submittedHash.toString(),\n            title: submittedTitle.toString(),\n        });\n\n        // Insert the content into the editor\n        editor.selection.moveToBookmark(openingSelection);\n        editor.execCommand('mceInsertContent', false, content.html);\n        editor.selection.moveToBookmark(openingSelection);\n\n        tbl.dataset.selected = '';\n        tbl.dataset.title = '';\n        const rows = tbl.querySelectorAll('tbody tr');\n        rows.forEach(row => row.classList.remove('selected'));\n\n        console.log('Dialog submission handled and table cleared.');\n    } catch (error) {\n        console.error('Error handling dialog submission:', error);\n    } finally {\n        pendingPromise.resolve();\n    }\n    modal.destroy();\n};\n\nconst displayDialogue = async(editor, data = {}) => {\n\n    const templatecontext = await getTemplateContext(editor, data);\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        templateContext: templatecontext,\n        large: true,\n    });\n\n    modal.show();\n\n    const $root = modal.getRoot();\n    initTable('videolist' + templatecontext.tableid, 'videolistsearchinput' + templatecontext.tableid);\n    $root.on(ModalEvents.save, (event, modal) => {\n        handleDialogueSubmission(editor, modal, data);\n    });\n\n    $root.on(ModalEvents.shown, function () {\n        const tbl = modal.getRoot().find('table').get(0);\n        if (!tbl) {\n            console.error('Table with id #videolist not found.');\n            return;\n        }\n\n        tbl.addEventListener('click', (event) => {\n            const row = event.target.closest('tr');\n            if (!row || !tbl.contains(row)) {\n                return;\n            }\n            const hash = row.dataset.contenthash;\n            const title = row.dataset.title;\n            if (hash) {\n                const rows = tbl.querySelectorAll('tbody tr');\n                rows.forEach(r => r.classList.remove('selected'));\n                row.classList.add('selected');\n                tbl.dataset.selected = hash;\n                tbl.dataset.title = title;\n            } else {\n                console.warn('No content hash found for the selected row.');\n            }\n        });\n    });\n\n};\n"],"names":["openingSelection","editor","selection","getBookmark","displayDialogue","getTemplateContext","async","data","canEmbed","embed","canUploadAndEmbed","videos","fetchVideos","Object","assign","elementid","id","canUpload","showOptions","uploadlink","tableid","Date","now","request","methodname","args","responses","Ajax","call","list","error","console","handleDialogueSubmission","modal","pendingPromise","Pending","tbl","getRoot","find","get","reject","submittedHash","dataset","selected","submittedTitle","title","destroy","hash","invalidHash","resolve","content","component","toString","moveToBookmark","execCommand","html","querySelectorAll","forEach","row","classList","remove","log","templatecontext","ModalFactory","create","type","Modal","TYPE","templateContext","large","show","$root","on","ModalEvents","save","event","shown","addEventListener","target","closest","contains","contenthash","r","add","warn"],"mappings":";;;;;;;;4TAkCIA,iBAAmB,2BAEMC,SACzBD,iBAAmBC,OAAOC,UAAUC,cACpCC,gBAAgBH,eAWdI,mBAAqBC,MAAOL,OAAQM,qCAIhCC,qCAHc,2BAAeP,QAGNQ,wDACvBC,kBAAiCF,SAGjCG,aAAeC,qBACdC,OAAOC,OAAO,GAAI,CACrBC,UAAWd,OAAOe,GAClBC,UARc,KASdT,SAAAA,SACAE,kBAAAA,kBACAQ,aAAa,EACbP,OAAAA,OACAQ,YAAY,EACZC,QAASC,KAAKC,OACff,OAQDK,YAAcN,oBAENiB,QAAU,CACZC,WAAY,8BACZC,KAAM,IAEJC,gBAAkBC,cAAKC,KAAK,CAACL,UAAU,UAC9BG,UAAUG,MACR,GACnB,MAAOC,cACLC,QAAQD,MAAM,yBAA0BA,OACjC,KAITE,yBAA2B1B,MAAOL,OAAQgC,MAAO1B,cAC7C2B,eAAiB,IAAIC,iBAAQ,6CAE7BC,IAAMH,MAAMI,UAAUC,KAAK,SAASC,IAAI,OACzCH,WACDL,QAAQD,MAAM,iCACdI,eAAeM,eAIbC,cAAgBL,IAAIM,QAAQC,SAC5BC,eAAiBR,IAAIM,QAAQG,UAC9BJ,qBACDV,QAAQD,MAAM,2DACdG,MAAMa,UACN1C,gBAAgBH,OAAQY,OAAOC,OAAO,GAAIP,KAAM,CAC5CwC,KAAMN,cACNO,aAAa,UAEjBd,eAAee,oBAKTC,cAAgB,yCAAoBC,8BAAqB,CAC3DJ,KAAMN,cAAcW,WACpBP,MAAOD,eAAeQ,aAI1BnD,OAAOC,UAAUmD,eAAerD,kBAChCC,OAAOqD,YAAY,oBAAoB,EAAOJ,QAAQK,MACtDtD,OAAOC,UAAUmD,eAAerD,kBAEhCoC,IAAIM,QAAQC,SAAW,GACvBP,IAAIM,QAAQG,MAAQ,GACPT,IAAIoB,iBAAiB,YAC7BC,SAAQC,KAAOA,IAAIC,UAAUC,OAAO,cAEzC7B,QAAQ8B,IAAI,gDACd,MAAO/B,OACLC,QAAQD,MAAM,oCAAqCA,eAEnDI,eAAee,UAEnBhB,MAAMa,WAGJ1C,gBAAkBE,eAAML,YAAQM,4DAAO,SAEnCuD,sBAAwBzD,mBAAmBJ,OAAQM,MACnD0B,YAAc8B,uBAAaC,OAAO,CACpCC,KAAMC,eAAMC,KACZC,gBAAiBN,gBACjBO,OAAO,IAGXpC,MAAMqC,aAEAC,MAAQtC,MAAMI,+BACV,YAAcyB,gBAAgB1C,QAAS,uBAAyB0C,gBAAgB1C,SAC1FmD,MAAMC,GAAGC,sBAAYC,MAAM,CAACC,MAAO1C,SAC/BD,yBAAyB/B,OAAQgC,MAAO1B,SAG5CgE,MAAMC,GAAGC,sBAAYG,OAAO,iBAClBxC,IAAMH,MAAMI,UAAUC,KAAK,SAASC,IAAI,GACzCH,IAKLA,IAAIyC,iBAAiB,SAAUF,cACrBjB,IAAMiB,MAAMG,OAAOC,QAAQ,UAC5BrB,MAAQtB,IAAI4C,SAAStB,kBAGpBX,KAAOW,IAAIhB,QAAQuC,YACnBpC,MAAQa,IAAIhB,QAAQG,SACtBE,KAAM,CACOX,IAAIoB,iBAAiB,YAC7BC,SAAQyB,GAAKA,EAAEvB,UAAUC,OAAO,cACrCF,IAAIC,UAAUwB,IAAI,YAClB/C,IAAIM,QAAQC,SAAWI,KACvBX,IAAIM,QAAQG,MAAQA,WAEpBd,QAAQqD,KAAK,kDAlBjBrD,QAAQD,MAAM"}